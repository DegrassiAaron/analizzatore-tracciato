<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Tracciati</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #323233;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 20px;
            overflow-y: auto;
        }

        .upload-area {
            border: 2px dashed #007acc;
            border-radius: 6px;
            padding: 30px 20px;
            text-align: center;
            background: #2d2d30;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #333337;
            border-color: #4dafff;
        }

        .upload-area.dragover {
            background: #37373d;
            border-color: #4dafff;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: #005a9e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .btn-success {
            background: #16825d;
        }

        .btn-success:hover:not(:disabled) {
            background: #0e5f43;
        }

        .btn-danger {
            background: #f14c4c;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c93838;
        }

        .process-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: #2d2d30;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #007acc;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #4ec9b0;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #858585;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: #2d2d30;
        }

        thead {
            position: sticky;
            top: 0;
            background: #323233;
            z-index: 10;
        }

        th {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 2px solid #3e3e42;
            color: #cccccc;
            font-weight: 600;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #3e3e42;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #37373d;
        }

        tbody tr.selected {
            background: #2d4a5e;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #252526;
            margin: 2% auto;
            width: 95%;
            height: 90%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #323233;
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #4ec9b0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #3e3e42;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: #2d2d30;
            border: none;
            color: #858585;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 4px 4px 0 0;
        }

        .tab:hover {
            background: #37373d;
            color: #cccccc;
        }

        .tab.active {
            background: #007acc;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .block-section {
            margin-bottom: 30px;
            background: #2d2d30;
            border-radius: 6px;
            overflow: hidden;
        }

        .block-header {
            background: #323233;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .block-title {
            font-size: 14px;
            font-weight: 600;
            color: #4ec9b0;
        }

        .block-body {
            max-height: 400px;
            overflow: auto;
        }

        .progress-bar {
            background: #3e3e42;
            border-radius: 4px;
            height: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: #007acc;
            height: 100%;
            transition: width 0.3s;
        }

        .console {
            background: #1e1e1e;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .console-line {
            padding: 4px 0;
            border-bottom: 1px solid #2d2d30;
        }

        .console-line:last-child {
            border-bottom: none;
        }

        .console-time {
            color: #858585;
            margin-right: 10px;
        }

        .console-info {
            color: #4ec9b0;
        }

        .console-warning {
            color: #dcdcaa;
        }

        .console-error {
            color: #f48771;
        }

        .console-success {
            color: #16825d;
        }

        .warning-banner {
            background: #3d3d1a;
            border: 2px solid #dcdcaa;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            align-items: center;
            gap: 15px;
        }

        .warning-banner.show {
            display: flex;
        }

        .warning-icon {
            font-size: 32px;
        }

        .warning-text {
            flex: 1;
        }

        .warning-title {
            font-weight: 600;
            color: #dcdcaa;
            margin-bottom: 5px;
        }

        .warning-desc {
            font-size: 12px;
            color: #b5b5a0;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .selection-info {
            background: #2d2d30;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #858585;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <div class="panel-header">Caricamento File</div>
            <div class="panel-content">
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 32px; margin-bottom: 8px;">📁</div>
                    <div style="font-size: 13px; font-weight: 600;">Clicca o trascina file TXT</div>
                    <div style="font-size: 10px; color: #858585; margin-top: 5px;">Max 20 file, fino a 8GB</div>
                </div>
                <input type="file" id="fileInput" accept=".txt" multiple>
                
                <div id="fileList"></div>

                <button class="btn process-btn" id="processBtn" disabled>
                    Analizza File
                </button>

                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div id="statsContainer" style="display: none;">
                    <div class="stats-grid" id="stats"></div>
                </div>
            </div>
        </div>

        <div class="panel" id="consolePanel" style="display: none;">
            <div class="panel-header">
                Console Log
                <button class="btn btn-small" onclick="clearConsole()">Pulisci</button>
            </div>
            <div class="panel-content">
                <div class="console" id="console"></div>
            </div>
        </div>

        <div class="panel" id="resultsPanel" style="display: none;">
            <div class="panel-header">
                Documenti Analizzati
                <span id="docCount" style="font-size: 11px; color: #858585;"></span>
            </div>
            <div class="panel-content">
                <div id="warningBanner" class="warning-banner">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">
                        <div class="warning-title">Attenzione: Download di massa</div>
                        <div class="warning-desc">Hai selezionato più di 10 tracciati. Il download potrebbe richiedere tempo e causare rallentamenti del browser.</div>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-small" onclick="selectAll()">Seleziona Tutti</button>
                    <button class="btn btn-small" onclick="deselectAll()">Deseleziona Tutti</button>
                    <button class="btn btn-small btn-success" id="downloadSelectedSingleBtn" onclick="downloadSelectedSingle()" disabled>
                        📥 Scarica Selezionati
                    </button>
                    <button class="btn btn-small btn-success" id="downloadSelectedBtn" onclick="downloadSelected()" disabled>
                        📥 Scarica Selezionati (ZIP)
                    </button>
                    <div class="selection-info" id="selectionInfo">Nessun tracciato selezionato</div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="documentsTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>Codice Compagnia</th>
                                <th>Numero Contratto</th>
                                <th>Progressivo Contratto</th>
                                <th>Blocchi Trovati</th>
                                <th>Righe Totali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Analisi Tracciato</div>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs" id="tabs"></div>
                <div id="tabsContent"></div>
            </div>
        </div>
    </div>

    <script>
        const BLOCK_DEFINITIONS = {
            'CNT': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'DAT_FINE_VAL', pos: 26, len: 10 },
                { name: 'TIP_PORTAF', pos: 36, len: 1 },
                { name: 'COD_STATO_PTF', pos: 37, len: 1 },
                { name: 'TIP_DOCUMENTO_MOD', pos: 38, len: 2 },
                { name: 'NUM_DOCUMENTO_MOD', pos: 40, len: 14 },
                { name: 'DAT_DECORRENZA', pos: 54, len: 10 },
                { name: 'DAT_SCADENZA', pos: 64, len: 10 },
                { name: 'NUM_DURATA', pos: 74, len: 8 },
                { name: 'COD_FRAZIONAMENTO', pos: 82, len: 1 },
                { name: 'NUM_AGENZIA', pos: 83, len: 8 },
                { name: 'COD_ESENZIONE', pos: 91, len: 1 },
                { name: 'COD_ANNULL_CON', pos: 92, len: 3 },
                { name: 'DAT_ANNULL_CON', pos: 95, len: 10 },
                { name: 'COD_ANNULL_SUB', pos: 105, len: 3 },
                { name: 'COD_ANNULL_USER', pos: 108, len: 8 },
                { name: 'DAT_ANNULL_REG', pos: 116, len: 10 },
                { name: 'KEY_AUTOR', pos: 126, len: 10 },
                { name: 'COD_COASS', pos: 136, len: 1 },
                { name: 'COD_VINCOLO', pos: 137, len: 1 },
                { name: 'COD_RINNOVO', pos: 138, len: 1 },
                { name: 'TIP_CONVENZ', pos: 139, len: 1 },
                { name: 'COD_CONVERS', pos: 140, len: 2 },
                { name: 'COD_VALUTA', pos: 142, len: 4 },
                { name: 'ORA_DEC_IMMEDIATA', pos: 146, len: 5 },
                { name: 'COD_PER_RESCIND', pos: 151, len: 2 },
                { name: 'DAT_RESCINDIB', pos: 153, len: 10 },
                { name: 'TIP_STRUTTURA', pos: 163, len: 2 },
                { name: 'COD_DIR_CONTI', pos: 165, len: 2 },
                { name: 'DAT_RIF_TABELLE', pos: 167, len: 10 },
                { name: 'COD_LINGUA', pos: 177, len: 2 },
                { name: 'COD_FRAZ_PROROG', pos: 179, len: 1 },
                { name: 'COD_CONGUAGLIO', pos: 180, len: 1 },
                { name: 'DAT_APPLIC_AR', pos: 181, len: 10 },
                { name: 'TIP_RISK', pos: 191, len: 1 },
                { name: 'DAT_RIATTIVAZ', pos: 192, len: 10 },
                { name: 'COD_RIASS', pos: 202, len: 4 },
                { name: 'COD_INDICIZZ', pos: 206, len: 1 },
                { name: 'COD_BLOK_INDIC', pos: 207, len: 1 },
                { name: 'COD_TAB_INDIC', pos: 208, len: 2 },
                { name: 'COD_GEST_PROVV', pos: 210, len: 1 },
                { name: 'COD_RIPRESA', pos: 211, len: 2 },
                { name: 'COD_PRODOTTO_GRV', pos: 213, len: 6 },
                { name: 'COD_PROD_SUPER', pos: 219, len: 4 },
                { name: 'COD_EDIZ_STAMPATO', pos: 223, len: 4 },
                { name: 'COD_RAMOPOL', pos: 227, len: 4 },
                { name: 'COD_CATEGORIA', pos: 231, len: 4 },
                { name: 'COD_STORNO_SIDA', pos: 235, len: 3 },
                { name: 'PER_NS_QUOTA', pos: 238, len: 7 },
                { name: 'FLG_CONDELEGA', pos: 245, len: 1 },
                { name: 'COD_ACQUISITORE', pos: 246, len: 7 },
                { name: 'DAT_CONTAB_PROT', pos: 253, len: 10 },
                { name: 'DAT_CONTAB_ANN', pos: 263, len: 10 },
                { name: 'DAT_INIZ_VAL', pos: 273, len: 10 },
                { name: 'COD_USER_INS', pos: 283, len: 8 },
                { name: 'TMS_INS', pos: 291, len: 28 },
                { name: 'COD_USER_MOD', pos: 317, len: 8 },
                { name: 'TMS_MOD', pos: 325, len: 28 },
                { name: 'COD_ADEGUAMENTO', pos: 351, len: 1 },
                { name: 'COD_COMP_C', pos: 352, len: 4 },
                { name: 'FLG_DIGITALE', pos: 356, len: 1 },
                { name: 'COD_PROPOSTA', pos: 357, len: 1 },
                { name: 'COD_MODULARE', pos: 358, len: 1 },
                { name: 'COD_ANTIMAFIA', pos: 359, len: 1 }
            ],
            'SCH': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'DAT_FINE_VAL', pos: 34, len: 10 },
                { name: 'COD_RAMO_ATOM', pos: 44, len: 5 },
                { name: 'DAT_DECORRENZA', pos: 49, len: 10 },
                { name: 'DAT_SCADENZA', pos: 59, len: 10 },
                { name: 'IMP_PREMIO', pos: 69, len: 16 },
                { name: 'COD_ANN_SKE', pos: 85, len: 2 },
                { name: 'DAT_ANN_SKE', pos: 87, len: 10 },
                { name: 'COD_ANNULL_USER', pos: 97, len: 8 },
                { name: 'DAT_ANNULL_REG', pos: 105, len: 10 },
                { name: 'TIP_DOCUMENTO_MOD', pos: 115, len: 2 },
                { name: 'NUM_DOCUMENTO_MOD', pos: 117, len: 14 },
                { name: 'COD_RICALCOLO', pos: 131, len: 1 },
                { name: 'TIP_RINNOVO_SCHEDA', pos: 132, len: 2 },
                { name: 'COD_CONTAB', pos: 134, len: 1 },
                { name: 'COD_RAMO_FORTE', pos: 135, len: 5 },
                { name: 'COD_RELAZIONE', pos: 140, len: 1 },
                { name: 'PRG_MADRE', pos: 141, len: 8 },
                { name: 'TIP_RISK_PROVV', pos: 149, len: 3 },
                { name: 'COD_VALUTA', pos: 152, len: 4 },
                { name: 'COD_CONVERS', pos: 156, len: 2 },
                { name: 'DAT_APPLIC_DC', pos: 158, len: 10 },
                { name: 'COD_DIR_CONTI', pos: 168, len: 2 },
                { name: 'COD_CONGUAGLIO', pos: 170, len: 1 },
                { name: 'COD_INDICIZZ', pos: 171, len: 1 },
                { name: 'COD_BLOK_INDIC', pos: 172, len: 1 },
                { name: 'COD_TAB_INDIC', pos: 173, len: 2 },
                { name: 'DAT_ULT_INDIC', pos: 175, len: 10 },
                { name: 'NUM_ISTAT', pos: 185, len: 5 },
                { name: 'PER_INCRE_ISTAT', pos: 190, len: 8 },
                { name: 'PER_INCRE_ETA', pos: 198, len: 8 },
                { name: 'COD_LANCIO_PVAG', pos: 206, len: 7 },
                { name: 'COD_RAMOGAR', pos: 213, len: 4 },
                { name: 'COD_CATEG_GAR', pos: 217, len: 4 },
                { name: 'DAT_INIZ_VAL', pos: 221, len: 10 },
                { name: 'COD_USER_INS', pos: 231, len: 8 },
                { name: 'TMS_INS', pos: 239, len: 28 },
                { name: 'COD_USER_MOD', pos: 265, len: 8 },
                { name: 'TMS_MOD', pos: 273, len: 28 },
                { name: 'COD_ADEGUAMENTO', pos: 299, len: 1 },
                { name: 'DAT_ADEGUAMENTO', pos: 300, len: 10 },
                { name: 'COD_LIVELLO_ADEG', pos: 310, len: 1 }
            ],
            'PRT': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 6 },
                { name: 'DAT_FINE_VAL', pos: 40, len: 10 },
                { name: 'COD_RAMO_ATOM', pos: 50, len: 5 },
                { name: 'COD_GAR_LIV1', pos: 55, len: 3 },
                { name: 'COD_GAR_LIV2', pos: 58, len: 3 },
                { name: 'COD_GAR_LIV3', pos: 61, len: 3 },
                { name: 'COD_GAR_SUB', pos: 64, len: 1 },
                { name: 'COD_CLA_ID', pos: 65, len: 3 },
                { name: 'COD_CLA_SUB', pos: 68, len: 1 },
                { name: 'DAT_TARIFFA', pos: 69, len: 10 },
                { name: 'COD_TARIFFA', pos: 79, len: 3 },
                { name: 'DAT_INGRESSO_TAR', pos: 82, len: 10 },
                { name: 'IMP_PREMIO', pos: 92, len: 14 },
                { name: 'COD_VALUTA', pos: 106, len: 4 },
                { name: 'COD_TAR_PROVIN', pos: 110, len: 3 },
                { name: 'COD_TAR_ZONA', pos: 113, len: 3 },
                { name: 'IMP_PREMIO_TECNICO', pos: 116, len: 14 },
                { name: 'COD_FORZATURA', pos: 130, len: 1 },
                { name: 'DAT_INIZ_VAL', pos: 131, len: 10 },
                { name: 'COD_USER_INS', pos: 141, len: 8 },
                { name: 'TMS_INS', pos: 149, len: 28 },
                { name: 'COD_USER_MOD', pos: 175, len: 8 },
                { name: 'TMS_MOD', pos: 183, len: 28 }
            ],
            'PAX': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 6 },
                { name: 'PRG_RCD_PARAM', pos: 40, len: 2 },
                { name: 'DAT_FINE_VAL', pos: 42, len: 10 },
                { name: 'COD_CLA_ID_01', pos: 52, len: 3 },
                { name: 'COD_CLA_SUB_01', pos: 55, len: 1 },
                { name: 'NUM_PVLS_01', pos: 56, len: 8 },
                { name: 'VAL_PARAMETRO_01', pos: 64, len: 14 },
                { name: 'COD_PRESTAZ_01', pos: 78, len: 2 },
                { name: 'COD_CLA_ID_02', pos: 80, len: 3 },
                { name: 'COD_CLA_SUB_02', pos: 83, len: 1 },
                { name: 'NUM_PVLS_02', pos: 84, len: 8 },
                { name: 'VAL_PARAMETRO_02', pos: 92, len: 14 },
                { name: 'COD_PRESTAZ_02', pos: 106, len: 2 },
                { name: 'COD_CLA_ID_03', pos: 108, len: 3 },
                { name: 'COD_CLA_SUB_03', pos: 111, len: 1 },
                { name: 'NUM_PVLS_03', pos: 112, len: 8 },
                { name: 'VAL_PARAMETRO_03', pos: 120, len: 14 },
                { name: 'COD_PRESTAZ_03', pos: 134, len: 2 },
                { name: 'COD_CLA_ID_04', pos: 136, len: 3 },
                { name: 'COD_CLA_SUB_04', pos: 139, len: 1 },
                { name: 'NUM_PVLS_04', pos: 140, len: 8 },
                { name: 'VAL_PARAMETRO_04', pos: 148, len: 14 },
                { name: 'COD_PRESTAZ_04', pos: 162, len: 2 },
                { name: 'COD_CLA_ID_05', pos: 164, len: 3 },
                { name: 'COD_CLA_SUB_05', pos: 167, len: 1 },
                { name: 'NUM_PVLS_05', pos: 168, len: 8 },
                { name: 'VAL_PARAMETRO_05', pos: 176, len: 14 },
                { name: 'COD_PRESTAZ_05', pos: 190, len: 2 },
                { name: 'COD_CLA_ID_06', pos: 192, len: 3 },
                { name: 'COD_CLA_SUB_06', pos: 195, len: 1 },
                { name: 'NUM_PVLS_06', pos: 196, len: 8 },
                { name: 'VAL_PARAMETRO_06', pos: 204, len: 14 },
                { name: 'COD_PRESTAZ_06', pos: 218, len: 2 },
                { name: 'COD_CLA_ID_07', pos: 220, len: 3 },
                { name: 'COD_CLA_SUB_07', pos: 223, len: 1 },
                { name: 'NUM_PVLS_07', pos: 224, len: 8 },
                { name: 'VAL_PARAMETRO_07', pos: 232, len: 14 },
                { name: 'COD_PRESTAZ_07', pos: 246, len: 2 },
                { name: 'COD_CLA_ID_08', pos: 248, len: 3 },
                { name: 'COD_CLA_SUB_08', pos: 251, len: 1 },
                { name: 'NUM_PVLS_08', pos: 252, len: 8 },
                { name: 'VAL_PARAMETRO_08', pos: 260, len: 14 },
                { name: 'COD_PRESTAZ_08', pos: 274, len: 2 },
                { name: 'COD_CLA_ID_09', pos: 276, len: 3 },
                { name: 'COD_CLA_SUB_09', pos: 279, len: 1 },
                { name: 'NUM_PVLS_09', pos: 280, len: 8 },
                { name: 'VAL_PARAMETRO_09', pos: 288, len: 14 },
                { name: 'COD_PRESTAZ_09', pos: 302, len: 2 },
                { name: 'COD_CLA_ID_10', pos: 304, len: 3 },
                { name: 'COD_CLA_SUB_10', pos: 307, len: 1 },
                { name: 'NUM_PVLS_10', pos: 308, len: 8 },
                { name: 'VAL_PARAMETRO_10', pos: 316, len: 14 },
                { name: 'COD_PRESTAZ_10', pos: 330, len: 2 },
                { name: 'DAT_INIZ_VAL', pos: 332, len: 10 },
                { name: 'COD_USER_INS', pos: 342, len: 8 },
                { name: 'TMS_INS', pos: 350, len: 28 },
                { name: 'COD_INDICIZZ_01', pos: 376, len: 1 },
                { name: 'COD_INDICIZZ_02', pos: 377, len: 1 },
                { name: 'COD_INDICIZZ_03', pos: 378, len: 1 },
                { name: 'COD_INDICIZZ_04', pos: 379, len: 1 },
                { name: 'COD_INDICIZZ_05', pos: 380, len: 1 },
                { name: 'COD_INDICIZZ_06', pos: 381, len: 1 },
                { name: 'COD_INDICIZZ_07', pos: 382, len: 1 },
                { name: 'COD_INDICIZZ_08', pos: 383, len: 1 },
                { name: 'COD_INDICIZZ_09', pos: 384, len: 1 },
                { name: 'COD_INDICIZZ_10', pos: 385, len: 1 }
            ],
            'RIS': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 6 },
                { name: 'NUM_QUESTION', pos: 40, len: 8 },
                { name: 'NUM_DOMANDA', pos: 48, len: 6 },
                { name: 'PRG_RISPOSTA', pos: 54, len: 4 },
                { name: 'NUM_RIGA_RISP', pos: 58, len: 4 },
                { name: 'DAT_FINE_VAL', pos: 62, len: 10 },
                { name: 'TIP_RISPOSTA', pos: 72, len: 1 },
                { name: 'TIP_DATA', pos: 73, len: 1 },
                { name: 'VAL_RISPOSTA', pos: 74, len: 14 },
                { name: 'TXT_RISPOSTA', pos: 88, len: 70 },
                { name: 'NUM_LISTA', pos: 158, len: 8 },
                { name: 'COD_VALUTA', pos: 166, len: 4 },
                { name: 'DAT_INIZ_VAL', pos: 170, len: 10 },
                { name: 'COD_USER_INS', pos: 180, len: 8 },
                { name: 'TMS_INS', pos: 188, len: 28 },
                { name: 'COD_USER_MOD', pos: 214, len: 8 },
                { name: 'TMS_MOD', pos: 222, len: 28 }
            ],
            'DOC': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'TIP_DOCUMENTO', pos: 4, len: 2 },
                { name: 'NUM_DOCUMENTO', pos: 6, len: 14 },
                { name: 'NUM_CONTRATTO', pos: 20, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 34, len: 8 },
                { name: 'COD_DOC_CLASSIF', pos: 42, len: 2 },
                { name: 'DAT_EFFETTO_COP', pos: 44, len: 10 },
                { name: 'DAT_SCAD_COP', pos: 54, len: 10 },
                { name: 'DAT_REGOLAZ', pos: 64, len: 10 },
                { name: 'TIP_DOCUMENTO_SOS', pos: 74, len: 2 },
                { name: 'NUM_DOCUMENTO_SOS', pos: 76, len: 14 },
                { name: 'NUM_AGENZIA_EMISS', pos: 90, len: 8 },
                { name: 'DAT_EMISSIONE', pos: 98, len: 10 },
                { name: 'COD_STATO', pos: 108, len: 1 },
                { name: 'COD_ANNULL_DOC', pos: 109, len: 1 },
                { name: 'NUM_DISTINTA', pos: 110, len: 14 },
                { name: 'NUM_OPERAZIONE', pos: 124, len: 6 },
                { name: 'NUM_QUESTION', pos: 130, len: 8 },
                { name: 'COD_SUB_CLASSIF', pos: 138, len: 1 },
                { name: 'DAT_CONVALIDA', pos: 139, len: 10 },
                { name: 'DAT_PAGAMENTO', pos: 149, len: 10 },
                { name: 'NUM_RIF_CATAL', pos: 159, len: 8 },
                { name: 'COD_CONVERS', pos: 167, len: 2 },
                { name: 'COD_VALUTA', pos: 169, len: 4 },
                { name: 'NUM_STAMPE', pos: 173, len: 4 },
                { name: 'COD_DIR_CONTI', pos: 177, len: 2 },
                { name: 'COD_FASE_CARTA', pos: 179, len: 1 },
                { name: 'COD_TRASM', pos: 180, len: 2 },
                { name: 'COD_ADEGUA', pos: 182, len: 1 },
                { name: 'COD_CONGUA', pos: 183, len: 1 },
                { name: 'COD_FIRMA', pos: 184, len: 1 },
                { name: 'NUM_VERSIONE', pos: 185, len: 6 },
                { name: 'PER_APP_BERS_PI', pos: 191, len: 6 },
                { name: 'PER_NUOVA_PROD_PA', pos: 197, len: 6 },
                { name: 'DAT_CONTAB_DOC', pos: 203, len: 10 },
                { name: 'COD_USER_INS', pos: 213, len: 8 },
                { name: 'TMS_INS', pos: 221, len: 26 },
                { name: 'COD_USER_MOD', pos: 247, len: 8 },
                { name: 'TMS_MOD', pos: 255, len: 28 },
                { name: 'COD_COMP_C', pos: 281, len: 4 },
                { name: 'TIP_CM', pos: 285, len: 3 },
                { name: 'FLG_DIGITALE', pos: 288, len: 1 },
                { name: 'FLG_RIEMISSIONE', pos: 289, len: 1 },
                { name: 'DAT_IMPOSTE', pos: 290, len: 10 },
                { name: 'TIP_OPERAZIONE', pos: 300, len: 3 },
                { name: 'COD_SUBPROCESSO', pos: 303, len: 3 },
                { name: 'COD_CONTABILITA', pos: 306, len: 1 },
                { name: 'COD_MOD_PAGAMENTO', pos: 307, len: 2 }
            ],
            'RIN': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 6 },
                { name: 'KEY_OGG_RISCHIO', pos: 40, len: 12 },
                { name: 'COD_RUOLO', pos: 52, len: 3 },
                { name: 'NUM_QUESTION', pos: 55, len: 8 },
                { name: 'NUM_DOMANDA', pos: 63, len: 6 },
                { name: 'PRG_RISPOSTA', pos: 69, len: 4 },
                { name: 'NUM_RIGA_RISP', pos: 73, len: 4 },
                { name: 'DAT_FINE_VAL', pos: 77, len: 10 },
                { name: 'TIP_RISPOSTA', pos: 87, len: 1 },
                { name: 'TIP_DATA', pos: 88, len: 1 },
                { name: 'VAL_RISPOSTA', pos: 89, len: 14 },
                { name: 'TXT_RISPOSTA', pos: 103, len: 70 },
                { name: 'NUM_LISTA', pos: 173, len: 8 },
                { name: 'COD_VALUTA', pos: 181, len: 4 },
                { name: 'DAT_INIZ_VAL', pos: 185, len: 10 },
                { name: 'COD_USER_INS', pos: 195, len: 8 },
                { name: 'TMS_INS', pos: 203, len: 28 },
                { name: 'COD_USER_MOD', pos: 229, len: 8 },
                { name: 'TMS_MOD', pos: 237, len: 28 }
            ],
            'SFO': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'TIP_DOCUMENTO', pos: 4, len: 2 },
                { name: 'NUM_DOCUMENTO', pos: 6, len: 14 },
                { name: 'PRG_SFORATURA', pos: 20, len: 8 },
                { name: 'TIP_AUTOR', pos: 28, len: 3 },
                { name: 'KEY_REC_AUTOR', pos: 31, len: 24 },
                { name: 'COD_LIV_AUTOR', pos: 55, len: 2 },
                { name: 'COD_MOTIVO_AUTOR', pos: 57, len: 4 },
                { name: 'COD_STATO_SFO', pos: 61, len: 1 },
                { name: 'TXT_CATAL', pos: 62, len: 70 },
                { name: 'COD_USER_INS', pos: 132, len: 8 },
                { name: 'TMS_INS', pos: 140, len: 28 },
                { name: 'COD_USER_MOD', pos: 166, len: 8 },
                { name: 'TMS_MOD', pos: 174, len: 28 }
            ],
            'AGE': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'NUM_AGENZIA', pos: 26, len: 8 },
                { name: 'DAT_FINE_VAL', pos: 34, len: 10 },
                { name: 'COD_SUBAGENZIA', pos: 44, len: 5 },
                { name: 'COD_SUBAGENTE', pos: 49, len: 4 },
                { name: 'COD_PRODUTTORE', pos: 53, len: 7 },
                { name: 'COD_CARICO', pos: 60, len: 1 },
                { name: 'DAT_TRAS_SCOR', pos: 61, len: 10 },
                { name: 'DAT_EFF_COMPET', pos: 71, len: 10 },
                { name: 'DAT_REG_TRA_SCO', pos: 81, len: 10 },
                { name: 'NUM_AGENZIA_PREC', pos: 91, len: 8 },
                { name: 'DAT_SCAD_EFF_PREC', pos: 99, len: 10 },
                { name: 'PER_PROVV_ACQ', pos: 109, len: 6 },
                { name: 'PER_PROVV_INC', pos: 115, len: 6 },
                { name: 'DAT_CONTAB_GIRO', pos: 121, len: 10 },
                { name: 'DAT_INIZ_VAL', pos: 131, len: 10 },
                { name: 'COD_USER_INS', pos: 141, len: 8 },
                { name: 'TMS_INS', pos: 149, len: 28 },
                { name: 'COD_USER_MOD', pos: 175, len: 8 },
                { name: 'TMS_MOD', pos: 183, len: 28 },
                { name: 'COD_COMP_C', pos: 209, len: 4 },
                { name: 'COD_COMP_C_PREC', pos: 213, len: 4 }
            ],
            'COA': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'COD_DELEGATARIA', pos: 26, len: 1 },
                { name: 'COD_COMP_COASS', pos: 27, len: 4 },
                { name: 'NUM_AGENZIA_COASS', pos: 31, len: 8 },
                { name: 'DAT_FINE_VAL', pos: 39, len: 10 },
                { name: 'PER_QUOTA', pos: 49, len: 6 },
                { name: 'TXT_ULT_COMPAG', pos: 55, len: 70 },
                { name: 'COD_RIMBORSO', pos: 125, len: 2 },
                { name: 'DAT_INIZ_VAL', pos: 127, len: 10 },
                { name: 'COD_USER_INS', pos: 137, len: 8 },
                { name: 'TMS_INS', pos: 145, len: 28 },
                { name: 'COD_USER_MOD', pos: 171, len: 8 },
                { name: 'TMS_MOD', pos: 179, len: 28 },
                { name: 'PER_QUOTA_PREMIO', pos: 205, len: 6 },
                { name: 'FLG_DELEGA_SIN', pos: 211, len: 1 }
            ],
            'CVP': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'KEY_CONVENZIONE', pos: 26, len: 10 },
                { name: 'COD_CONVENZ_COMM', pos: 36, len: 6 },
                { name: 'DAT_INGRESSO_CONV', pos: 42, len: 10 },
                { name: 'DAT_USCITA_CONV', pos: 52, len: 10 },
                { name: 'COD_PROD_PARTIC', pos: 62, len: 1 },
                { name: 'COD_NAZIONALE', pos: 63, len: 1 },
                { name: 'COD_AZIENDA', pos: 64, len: 1 },
                { name: 'TIP_ACCORDO_CONV', pos: 65, len: 1 },
                { name: 'COD_USER_INS', pos: 66, len: 8 },
                { name: 'TMS_INS', pos: 74, len: 28 },
                { name: 'COD_USER_MOD', pos: 100, len: 8 },
                { name: 'TMS_MOD', pos: 108, len: 28 }
            ],
            'COI': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'COD_DATO', pos: 26, len: 10 },
                { name: 'COD_KEY_DATO', pos: 36, len: 30 },
                { name: 'DAT_FINE_VAL', pos: 66, len: 10 },
                { name: 'TIP_DATO', pos: 76, len: 3 },
                { name: 'TXT_DATO', pos: 79, len: 255 },
                { name: 'DAT_INIZ_VAL', pos: 334, len: 10 },
                { name: 'COD_USER_INS', pos: 344, len: 8 },
                { name: 'TMS_INS', pos: 352, len: 28 },
                { name: 'COD_USER_MOD', pos: 378, len: 8 },
                { name: 'TMS_MOD', pos: 386, len: 28 }
            ],
            'PCE': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 8 },
                { name: 'PRG_RCD_PARAM', pos: 42, len: 2 },
                { name: 'NUM_PARAM', pos: 44, len: 3 },
                { name: 'DAT_RIFERIMENTO', pos: 47, len: 10 },
                { name: 'COD_COMUNICAZIONE', pos: 57, len: 1 },
                { name: 'DAT_FINE_VAL', pos: 58, len: 10 },
                { name: 'FLG_DECISIONALE', pos: 68, len: 4 },
                { name: 'FLG_AUMENTO_SCONTO', pos: 72, len: 1 },
                { name: 'DES_NOTA_LEN', pos: 73, len: 5 },
                { name: 'DES_NOTA_TEXT', pos: 78, len: 200 },
                { name: 'DES_PAR', pos: 278, len: 20 },
                { name: 'IMP_PAR', pos: 298, len: 16 },
                { name: 'COD_USER_INS', pos: 314, len: 8 },
                { name: 'TMS_INS', pos: 322, len: 28 },
                { name: 'COD_USER_MOD', pos: 348, len: 8 },
                { name: 'TMS_MOD', pos: 356, len: 28 },
                { name: 'DAT_INIZ_VAL', pos: 382, len: 10 },
                { name: 'PER_TASSO', pos: 392, len: 6 },
                { name: 'PER_INCRE', pos: 398, len: 6 },
                { name: 'IMP_PRE_MASSIMO', pos: 404, len: 14 }
            ],
            'LPS': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PCT_NSQUOTA', pos: 26, len: 7 },
                { name: 'DATA_RIFERIMENTO', pos: 33, len: 10 },
                { name: 'PAESE', pos: 43, len: 3 },
                { name: 'DESCR_PAESE', pos: 46, len: 50 },
                { name: 'VAL_ASSIC', pos: 96, len: 14 },
                { name: 'VAL_ASSIC_DI', pos: 110, len: 14 },
                { name: 'TAB_PARAM', pos: 124, len: 60 },
                { name: 'TAB_GAR', pos: 184, len: 567 }
            ],
            'PCB': [
                { name: 'COD_COMP', pos: 0, len: 4 },
                { name: 'NUM_CONTRATTO', pos: 4, len: 14 },
                { name: 'PRG_CONTRATTO', pos: 18, len: 8 },
                { name: 'PRG_SCHEDA', pos: 26, len: 8 },
                { name: 'PRG_PARTITA', pos: 34, len: 6 },
                { name: 'PRG_RECORD', pos: 40, len: 4 },
                { name: 'DAT_FINE_VAL', pos: 44, len: 10 },
                { name: 'PER_RIPART', pos: 54, len: 8 },
                { name: 'COD_RAMO_FORTE', pos: 62, len: 5 },
                { name: 'DAT_INIZ_VAL', pos: 67, len: 10 },
                { name: 'COD_USER_INS', pos: 77, len: 8 },
                { name: 'TMS_INS', pos: 85, len: 28 },
                { name: 'COD_USER_MOD', pos: 111, len: 8 },
                { name: 'TMS_MOD', pos: 119, len: 28 }
            ]
        };

        const MAX_FILES = 20;
        let selectedFiles = [];
        let documentsData = new Map();
        const sourceFiles = new Map();
        let selectedDocs = new Set();

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statsContainer = document.getElementById('statsContainer');
        const stats = document.getElementById('stats');
        const resultsPanel = document.getElementById('resultsPanel');
        const tableBody = document.getElementById('tableBody');
        const docCount = document.getElementById('docCount');
        const analysisModal = document.getElementById('analysisModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const tabs = document.getElementById('tabs');
        const tabsContent = document.getElementById('tabsContent');
        const consolePanel = document.getElementById('consolePanel');
        const consoleEl = document.getElementById('console');
        const warningBanner = document.getElementById('warningBanner');
        const selectionInfo = document.getElementById('selectionInfo');
        const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
        const downloadSelectedSingleBtn = document.getElementById('downloadSelectedSingleBtn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        function logToConsole(message, type = 'info') {
            const time = new Date().toLocaleTimeString('it-IT');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `<span class="console-time">[${time}]</span><span class="console-${type}">${message}</span>`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            consolePanel.style.display = 'flex';
        }

        window.clearConsole = function() {
            consoleEl.innerHTML = '';
        }

        function formatSize(bytes) {
            if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(2) + ' GB';
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(2) + ' MB';
            return (bytes / 1024).toFixed(2) + ' KB';
        }

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function extractBlockId(line) {
            // Il blocco inizia alla posizione 200 ed è lungo 12 caratteri
            // Formato: [5 caratteri prefisso][3 caratteri ID blocco][4 cifre]
            // Esempio: WGRVBAGE0001 (posizioni 200-211)
            // ID blocco: posizioni 205-207 (AGE)
            if (line.length < 212) return null;
            
            const blockString = line.substring(200, 212);
            // Estrai i 3 caratteri dell'ID blocco (posizione 5-7 del blockString)
            const blockId = blockString.substring(5, 8);
            
            // Verifica che l'ID blocco esista nelle definizioni
            if (BLOCK_DEFINITIONS[blockId]) {
                return blockId;
            }
            
            return null;
        }

        function extractHeaderData(line) {
            if (line.length < 200) return null;
            
            return {
                codiceIniziale: line.substring(0, 10).trim(),
                data1: line.substring(10, 20),
                data2: line.substring(20, 30),
                campo7: line.substring(30, 37),
                codCompagnia: line.substring(37, 40),
                numContratto: line.substring(40, 53),
                prgContratto: line.substring(53, 61)
            };
        }

        function parseBlockData(line, blockId) {
            const definition = BLOCK_DEFINITIONS[blockId];
            if (!definition) return null;

            // I dati del blocco iniziano dopo l'identificatore del blocco
            // Posizione 200: inizio identificatore blocco (12 caratteri)
            // Posizione 212: inizio dati del blocco
            if (line.length < 212) return null;

            const dataStart = 212;
            const result = {};

            definition.forEach(field => {
                const startPos = dataStart + field.pos;
                const endPos = startPos + field.len;
                if (line.length >= endPos) {
                    const value = line.substring(startPos, endPos).trim();
                    result[field.name] = value;
                }
            });

            return result;
        }
                const startPos = dataStart + field.pos;
                const endPos = startPos + field.len;
                if (line.length >= endPos) {
                    const value = line.substring(startPos, endPos).trim();
                    result[field.name] = value;
                }
            });

            return result;
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        closeModal.addEventListener('click', () => {
            analysisModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === analysisModal) {
                analysisModal.style.display = 'none';
            }
        });

        function handleFiles(files) {
            const txtFiles = Array.from(files).filter(f => f.name.endsWith('.txt'));
            const availableSlots = MAX_FILES - selectedFiles.length;
            
            if (txtFiles.length > availableSlots) {
                logToConsole(`⚠️ Puoi aggiungere solo ${availableSlots} file. Limite massimo: ${MAX_FILES}`, 'warning');
                txtFiles.splice(availableSlots);
            }
            
            selectedFiles = [...selectedFiles, ...txtFiles].slice(0, MAX_FILES);
            logToConsole(`✓ Aggiunti ${txtFiles.length} file. Totale: ${selectedFiles.length}/${MAX_FILES}`, 'info');
            updateFileList();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'background:#2d2d30;padding:10px 15px;border-radius:4px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;font-size:12px;';
                div.innerHTML = `
                    <div>
                        <span>📄 ${file.name}</span>
                        <span style="color:#858585;margin-left:10px;">${formatSize(file.size)}</span>
                    </div>
                    <button onclick="removeFile(${index})" style="background:#f14c4c;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:11px;">×</button>
                `;
                fileList.appendChild(div);
            });
            processBtn.disabled = selectedFiles.length === 0;
        }

        window.removeFile = function(index) {
            const fileName = selectedFiles[index].name;
            selectedFiles.splice(index, 1);
            logToConsole(`✗ Rimosso file: ${fileName}`, 'info');
            updateFileList();
        }

        async function processFiles() {
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            documentsData.clear();
            sourceFiles.clear();
            selectedDocs.clear();

            logToConsole('🚀 Inizio elaborazione file...', 'info');

            let totalLines = 0;
            let totalDocs = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                updateProgress((i / selectedFiles.length) * 100);
                logToConsole(`⚙️ Elaborazione: ${file.name}`, 'info');

                try {
                    const text = await file.text();
                    const lines = text.split('\n');
                    
                    const docMap = new Map();
                    let blocksFound = new Set();
                    let linesParsed = 0;
                    let blocksNotFound = 0;

                    lines.forEach((line, lineNum) => {
                        if (line.trim().length === 0) return;
                        totalLines++;
                        linesParsed++;

                        const header = extractHeaderData(line);
                        if (!header) {
                            if (linesParsed <= 3) logToConsole(`⚠️ Riga ${lineNum + 1}: Header non valido`, 'warning');
                            return;
                        }

                        const blockId = extractBlockId(line);
                        
                        // Log dettagliato per le prime 3 righe
                        if (linesParsed <= 3) {
                            const blockString = line.length >= 212 ? line.substring(200, 212) : 'TROPPO CORTA';
                            logToConsole(`🔍 Riga ${lineNum + 1}: BlockString="${blockString}", BlockID="${blockId || 'NULL'}", Length=${line.length}`, 'info');
                        }
                        
                        if (blockId && BLOCK_DEFINITIONS[blockId]) {
                            blocksFound.add(blockId);
                        } else {
                            blocksNotFound++;
                            if (linesParsed <= 3 && line.length >= 212) {
                                logToConsole(`❌ Riga ${lineNum + 1}: BlockID non riconosciuto in BLOCK_DEFINITIONS`, 'error');
                            }
                        }
                        
                        const key = `${header.codCompagnia}-${header.numContratto}-${header.prgContratto}`;

                        if (!docMap.has(key)) {
                            docMap.set(key, {
                                header: header,
                                blocks: {},
                                lines: [],
                                sourceFile: file.name
                            });
                        }

                        const doc = docMap.get(key);
                        doc.lines.push(line);

                        if (blockId && BLOCK_DEFINITIONS[blockId]) {
                            if (!doc.blocks[blockId]) {
                                doc.blocks[blockId] = [];
                            }
                            const blockData = parseBlockData(line, blockId);
                            if (blockData) {
                                doc.blocks[blockId].push(blockData);
                            }
                        }
                    });

                    if (blocksFound.size > 0) {
                        logToConsole(`✓ Blocchi trovati in ${file.name}: ${Array.from(blocksFound).join(', ')}`, 'success');
                    } else {
                        logToConsole(`⚠️ Nessun blocco trovato in ${file.name} (${blocksNotFound} righe non riconosciute)`, 'warning');
                    }

                    docMap.forEach((doc, key) => {
                        documentsData.set(key, doc);
                        totalDocs++;
                    });

                    sourceFiles.set(file.name, file);
                    logToConsole(`✓ ${file.name}: ${docMap.size} documenti trovati`, 'success');

                } catch (error) {
                    logToConsole(`✗ Errore elaborando ${file.name}: ${error.message}`, 'error');
                }
            }

            updateProgress(100);
            
            stats.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${selectedFiles.length}</div>
                    <div class="stat-label">File processati</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${totalLines}</div>
                    <div class="stat-label">Righe totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${totalDocs}</div>
                    <div class="stat-label">Documenti trovati</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${Object.keys(BLOCK_DEFINITIONS).length}</div>
                    <div class="stat-label">Tipi di blocco</div>
                </div>
            `;

            logToConsole(`✓ Elaborazione completata: ${totalDocs} documenti da ${totalLines} righe`, 'success');

            statsContainer.style.display = 'block';
            renderDocumentsTable();
            
            progressContainer.style.display = 'none';
            updateProgress(0);
            processBtn.disabled = false;
            resultsPanel.style.display = 'flex';
            docCount.textContent = `${totalDocs} documenti`;
        }

        function renderDocumentsTable() {
            tableBody.innerHTML = '';
            
            documentsData.forEach((doc, key) => {
                const row = document.createElement('tr');
                const blockTypes = Object.keys(doc.blocks);
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="checkbox doc-checkbox" data-key="${key}" onchange="updateSelection()">
                    </td>
                    <td>${doc.header.codCompagnia}</td>
                    <td>${doc.header.numContratto}</td>
                    <td>${doc.header.prgContratto}</td>
                    <td>${blockTypes.join(', ') || 'Nessuno'}</td>
                    <td>${doc.lines.length}</td>
                    <td>
                        <button class="btn btn-small" onclick="openAnalysis('${key}')">
                            📊 Analisi
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        window.toggleSelectAll = function() {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                const key = cb.dataset.key;
                if (isChecked) {
                    selectedDocs.add(key);
                    cb.closest('tr').classList.add('selected');
                } else {
                    selectedDocs.delete(key);
                    cb.closest('tr').classList.remove('selected');
                }
            });
            
            updateSelection();
        }

        window.selectAll = function() {
            selectAllCheckbox.checked = true;
            toggleSelectAll();
        }

        window.deselectAll = function() {
            selectAllCheckbox.checked = false;
            toggleSelectAll();
        }

        window.updateSelection = function() {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            selectedDocs.clear();
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedDocs.add(cb.dataset.key);
                    cb.closest('tr').classList.add('selected');
                } else {
                    cb.closest('tr').classList.remove('selected');
                }
            });

            const count = selectedDocs.size;
            selectionInfo.textContent = count === 0 ? 'Nessun tracciato selezionato' : `${count} tracciato${count > 1 ? 'i' : ''} selezionato${count > 1 ? 'i' : ''}`;
            downloadSelectedBtn.disabled = count === 0;
            downloadSelectedSingleBtn.disabled = count === 0;
            
            if (count > 10) {
                warningBanner.classList.add('show');
            } else {
                warningBanner.classList.remove('show');
            }

            selectAllCheckbox.checked = count === checkboxes.length && count > 0;
        }

        window.downloadSelectedSingle = async function() {
            if (selectedDocs.size === 0) return;

            const count = selectedDocs.size;
            logToConsole(`📥 Inizio download di ${count} tracciati singoli...`, 'info');

            let downloaded = 0;
            for (const key of selectedDocs) {
                const doc = documentsData.get(key);
                if (doc) {
                    const content = doc.lines.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tracciato_${doc.header.numContratto}_${doc.header.prgContratto}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    downloaded++;
                    logToConsole(`✓ Download completato: ${a.download}`, 'success');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            logToConsole(`✓ Download completati: ${downloaded} file`, 'success');
        }

        window.downloadSelected = async function() {
            if (selectedDocs.size === 0) return;

            const count = selectedDocs.size;
            logToConsole(`📥 Inizio download di ${count} tracciati in formato ZIP...`, 'info');

            try {
                const zip = new JSZip();
                let processed = 0;

                for (const key of selectedDocs) {
                    const doc = documentsData.get(key);
                    if (doc) {
                        const content = doc.lines.join('\n');
                        const filename = `tracciato_${doc.header.numContratto}_${doc.header.prgContratto}.txt`;
                        zip.file(filename, content);
                        processed++;
                        logToConsole(`⚙️ Aggiunto al zip: ${filename} (${processed}/${count})`, 'info');
                    }
                }

                logToConsole('🔄 Generazione archivio ZIP...', 'info');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tracciati_export_${new Date().getTime()}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                logToConsole(`✓ Download completato: ${count} tracciato${count > 1 ? 'i' : ''} in archivio ZIP`, 'success');
            } catch (error) {
                logToConsole(`✗ Errore durante il download: ${error.message}`, 'error');
            }
        }

        window.openAnalysis = function(docKey) {
            const doc = documentsData.get(docKey);
            if (!doc) return;

            modalTitle.textContent = `Analisi Tracciato - ${doc.header.numContratto}`;
            
            tabs.innerHTML = '';
            tabsContent.innerHTML = '';

            const tabList = ['Dati Tracciato', ...Object.keys(doc.blocks)];
            
            tabList.forEach((tabName, index) => {
                const tab = document.createElement('button');
                tab.className = 'tab' + (index === 0 ? ' active' : '');
                tab.textContent = tabName;
                tab.onclick = () => switchTab(tabName, doc);
                tabs.appendChild(tab);
            });

            createDatiTracciatoTab(doc);
            
            analysisModal.style.display = 'block';
        }

        function switchTab(tabName, doc) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            tabsContent.innerHTML = '';
            
            if (tabName === 'Dati Tracciato') {
                createDatiTracciatoTab(doc);
            } else {
                createBlockTab(tabName, doc.blocks[tabName]);
            }
        }

        function createDatiTracciatoTab(doc) {
            const content = document.createElement('div');
            content.className = 'tab-content active';
            content.innerHTML = `
                <h3 style="color:#4ec9b0;margin-bottom:15px;">Informazioni Generali</h3>
                <table>
                    <tr><td style="font-weight:600;">Codice Compagnia</td><td>${doc.header.codCompagnia}</td></tr>
                    <tr><td style="font-weight:600;">Numero Contratto</td><td>${doc.header.numContratto}</td></tr>
                    <tr><td style="font-weight:600;">Progressivo Contratto</td><td>${doc.header.prgContratto}</td></tr>
                    <tr><td style="font-weight:600;">Data 1</td><td>${doc.header.data1}</td></tr>
                    <tr><td style="font-weight:600;">Data 2</td><td>${doc.header.data2}</td></tr>
                    <tr><td style="font-weight:600;">Righe Totali</td><td>${doc.lines.length}</td></tr>
                    <tr><td style="font-weight:600;">Blocchi Trovati</td><td>${Object.keys(doc.blocks).join(', ')}</td></tr>
                    <tr><td style="font-weight:600;">File Sorgente</td><td>${doc.sourceFile}</td></tr>
                </table>
            `;
            tabsContent.appendChild(content);
        }

        function createBlockTab(blockId, blockData) {
            if (!blockData || blockData.length === 0) {
                tabsContent.innerHTML = '<div style="text-align:center;padding:60px;color:#666;">Nessun dato disponibile per questo blocco</div>';
                return;
            }

            const content = document.createElement('div');
            content.className = 'tab-content active';
            
            const fields = Object.keys(blockData[0]);
            const stateKey = `blockState_${blockId}`;
            
            // Stato per questo blocco specifico
            const state = {
                hiddenColumns: new Set(),
                sortColumn: null,
                sortDirection: 'asc',
                currentPage: 0,
                rowsPerPage: 5,
                columnOrder: [...fields],
                draggedColumnIndex: null
            };

            function renderTable() {
                const visibleColumns = state.columnOrder.filter(f => !state.hiddenColumns.has(f));
                const totalPages = Math.ceil(blockData.length / state.rowsPerPage);
                
                let sortedData = [...blockData];
                if (state.sortColumn) {
                    sortedData.sort((a, b) => {
                        const valA = a[state.sortColumn] || '';
                        const valB = b[state.sortColumn] || '';
                        const comparison = valA.localeCompare(valB);
                        return state.sortDirection === 'asc' ? comparison : -comparison;
                    });
                }

                const startIdx = state.currentPage * state.rowsPerPage;
                const endIdx = Math.min(startIdx + state.rowsPerPage, sortedData.length);
                const pageData = sortedData.slice(startIdx, endIdx);

                let tableHTML = `
                    <div class="block-section">
                        <div class="block-header">
                            <div class="block-title">Blocco ${blockId} (${blockData.length} righe)</div>
                            <div style="display:flex;gap:10px;position:relative;">
                                <button class="btn btn-small" onclick="window.blockStates['${stateKey}'].toggleColumnMenu(event)">☰ Colonne</button>
                                <button class="btn btn-small" onclick="window.blockStates['${stateKey}'].resetColumns()">🔄 Reset</button>
                                <div id="columnMenu_${blockId}" style="display:none;position:absolute;background:#323233;border:1px solid #3e3e42;border-radius:4px;padding:10px;z-index:100;max-height:300px;overflow-y:auto;right:0;top:35px;">
                                    ${fields.map(field => `
                                        <label style="display:block;padding:5px;cursor:pointer;font-size:11px;white-space:nowrap;">
                                            <input type="checkbox" ${state.hiddenColumns.has(field) ? '' : 'checked'} onchange="window.blockStates['${stateKey}'].toggleColumn('${field}')" style="margin-right:5px;">
                                            ${field}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="block-body">
                            <table>
                                <thead>
                                    <tr>
                                        ${visibleColumns.map((field, idx) => `
                                            <th draggable="true" 
                                                ondragstart="window.blockStates['${stateKey}'].dragStart(event, ${idx})" 
                                                ondragover="window.blockStates['${stateKey}'].dragOver(event)" 
                                                ondrop="window.blockStates['${stateKey}'].drop(event, ${idx})" 
                                                style="cursor:move;user-select:none;" 
                                                onclick="window.blockStates['${stateKey}'].sortByColumn('${field}')">
                                                ${field} ${state.sortColumn === field ? (state.sortDirection === 'asc' ? '▲' : '▼') : ''}
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageData.map(row => `
                                        <tr>
                                            ${visibleColumns.map(field => `<td>${row[field] || '-'}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button ${state.currentPage === 0 ? 'disabled' : ''} onclick="window.blockStates['${stateKey}'].prevPage()">← Precedente</button>
                            <span>Pagina ${state.currentPage + 1} di ${totalPages}</span>
                            <button ${state.currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="window.blockStates['${stateKey}'].nextPage()">Successiva →</button>
                        </div>
                    </div>
                `;

                content.innerHTML = tableHTML;
            }

            // Crea oggetto con tutte le funzioni per questo blocco
            const blockFunctions = {
                toggleColumnMenu: function(event) {
                    event.stopPropagation();
                    const menu = document.getElementById(`columnMenu_${blockId}`);
                    if (menu.style.display === 'none') {
                        menu.style.display = 'block';
                    } else {
                        menu.style.display = 'none';
                    }
                },
                
                toggleColumn: function(field) {
                    if (state.hiddenColumns.has(field)) {
                        state.hiddenColumns.delete(field);
                    } else {
                        state.hiddenColumns.add(field);
                    }
                    renderTable();
                },
                
                resetColumns: function() {
                    state.hiddenColumns.clear();
                    state.columnOrder = [...fields];
                    state.sortColumn = null;
                    state.sortDirection = 'asc';
                    state.currentPage = 0;
                    renderTable();
                },
                
                sortByColumn: function(field) {
                    if (state.sortColumn === field) {
                        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sortColumn = field;
                        state.sortDirection = 'asc';
                    }
                    renderTable();
                },
                
                nextPage: function() {
                    const totalPages = Math.ceil(blockData.length / state.rowsPerPage);
                    if (state.currentPage < totalPages - 1) {
                        state.currentPage++;
                        renderTable();
                    }
                },
                
                prevPage: function() {
                    if (state.currentPage > 0) {
                        state.currentPage--;
                        renderTable();
                    }
                },
                
                dragStart: function(event, index) {
                    state.draggedColumnIndex = index;
                    event.dataTransfer.effectAllowed = 'move';
                },
                
                dragOver: function(event) {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'move';
                },
                
                drop: function(event, targetIndex) {
                    event.preventDefault();
                    if (state.draggedColumnIndex === null || state.draggedColumnIndex === targetIndex) return;

                    const visibleColumns = state.columnOrder.filter(f => !state.hiddenColumns.has(f));
                    const draggedField = visibleColumns[state.draggedColumnIndex];
                    const targetField = visibleColumns[targetIndex];

                    const draggedOriginalIdx = state.columnOrder.indexOf(draggedField);
                    const targetOriginalIdx = state.columnOrder.indexOf(targetField);

                    state.columnOrder.splice(draggedOriginalIdx, 1);
                    const newTargetIdx = state.columnOrder.indexOf(targetField);
                    state.columnOrder.splice(targetOriginalIdx > draggedOriginalIdx ? newTargetIdx + 1 : newTargetIdx, 0, draggedField);

                    state.draggedColumnIndex = null;
                    renderTable();
                }
            };

            // Salva le funzioni globalmente per questo blocco
            if (!window.blockStates) window.blockStates = {};
            window.blockStates[stateKey] = blockFunctions;

            // Chiudi il menu quando clicchi fuori
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    const menu = document.getElementById(`columnMenu_${blockId}`);
                    if (menu && !menu.contains(e.target) && !e.target.closest('.btn-small')) {
                        menu.style.display = 'none';
                    }
                });
            }, 100);

            renderTable();
            tabsContent.appendChild(content);
        }

        processBtn.addEventListener('click', processFiles);
    </script>
</body>
</html>